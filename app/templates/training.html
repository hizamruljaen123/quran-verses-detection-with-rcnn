{% extends "base.html" %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <h1 class="text-3xl font-black text-dark mb-1">Training Deep Neural Cortex</h1>
            <p class="text-slate-500 text-sm">Pemetaan dan pelatihan 41 ayat (0-40) An-Naba menggunakan arsitektur NumPy
                Modular.</p>
        </div>
        <button id="startTrainBtn"
            class="flex items-center px-6 py-3 bg-primary hover:bg-primary-dark text-white font-black rounded-2xl shadow-lg transition-all duration-300 hover:translate-y-[-2px] group">
            <i class="bi bi-play-fill text-xl mr-2 group-hover:scale-125 transition-transform"></i>
            Jalankan Training Mendalam
        </button>
    </div>

    <!-- Main Visualizer Area -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <!-- Phase & Progress Card -->
        <div class="lg:col-span-4 bg-white rounded-3xl p-8 shadow-sm border border-slate-100 flex flex-col">
            <h6 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-6">Status Aktif</h6>
            <div id="statusContainer" class="flex flex-col flex-grow">
                <div id="currentPhase"
                    class="inline-block px-3 py-1 rounded-full bg-slate-100 text-slate-500 text-[10px] font-black mb-4 self-start">
                    IDLE</div>
                <h4 id="statusText" class="text-2xl font-black text-dark mb-8">Siap Memulai</h4>

                <div class="mt-auto space-y-4">
                    <div class="flex justify-between items-end">
                        <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">Progres Global</span>
                        <span id="progressPercent" class="text-2xl font-black text-primary leading-none">0%</span>
                    </div>
                    <div class="relative h-3 w-full bg-slate-100 rounded-full overflow-hidden">
                        <div id="progressBar"
                            class="absolute top-0 left-0 h-full bg-primary transition-all duration-500 ease-out"
                            style="width: 0%">
                            <div
                                class="absolute right-0 top-0 h-full w-4 bg-white/20 skew-x-[-20deg] animate-[shimmer_2s_infinite]">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Stats -->
        <div class="lg:col-span-8 flex flex-col gap-8">
            <div class="bg-white rounded-3xl p-8 shadow-sm border border-slate-100">
                <div class="grid grid-cols-3 gap-8">
                    <div class="text-center">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Accuracy</p>
                        <h2 id="accVal" class="text-3xl font-black text-primary">--</h2>
                    </div>
                    <div class="text-center border-l border-slate-100">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Loss</p>
                        <h2 id="lossVal" class="text-3xl font-black text-amber-500">--</h2>
                    </div>
                    <div class="text-center border-l border-slate-100">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Memory</p>
                        <h2 class="text-3xl font-black text-indigo-500">80D</h2>
                    </div>
                </div>
            </div>

            <!-- Graph Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-slate-50 rounded-3xl p-6 border border-slate-200/50 relative overflow-hidden">
                    <div class="flex justify-between items-center mb-6 relative z-10">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Accuracy
                            Curve</span>
                        <i class="bi bi-graph-up text-primary"></i>
                    </div>
                    <div class="h-24 flex items-end gap-1 px-2 relative z-10" id="accGraph">
                        <!-- Dynamic Bars -->
                    </div>
                    <div class="absolute inset-0 bg-gradient-to-t from-emerald-500/5 to-transparent"></div>
                </div>
                <div class="bg-slate-50 rounded-3xl p-6 border border-slate-200/50 relative overflow-hidden">
                    <div class="flex justify-between items-center mb-6 relative z-10">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Loss Curve</span>
                        <i class="bi bi-graph-down text-rose-500"></i>
                    </div>
                    <div class="h-24 flex items-end gap-1 px-2 relative z-10" id="lossGraph">
                        <!-- Dynamic Bars -->
                    </div>
                    <div class="absolute inset-0 bg-gradient-to-t from-rose-500/5 to-transparent"></div>
                </div>
            </div>
        </div>

        <!-- Neural Cortex Grid -->
        <div class="lg:col-span-8">
            <div class="bg-dark rounded-3xl p-8 shadow-2xl relative overflow-hidden min-h-[420px] flex flex-col group">
                <h6 class="text-xs font-black text-slate-500 uppercase tracking-widest mb-12">Neural Cortex
                    Visualization</h6>

                <div class="flex justify-between items-center flex-grow px-12 relative z-10">
                    <!-- Layer 1: Input -->
                    <div class="flex flex-col items-center gap-1" id="layer1">
                        <div class="flex flex-col gap-4">
                            {% for i in range(4) %}
                            <div class="node w-4 h-4 rounded-full bg-blue-500/10 border border-blue-500/30"></div>
                            {% endfor %}
                        </div>
                        <span class="text-[8px] font-black text-slate-600 mt-4 uppercase">Input (80)</span>
                    </div>

                    <!-- SVG Connections -->
                    <div class="flex-grow h-32 relative mx-4">
                        <svg class="absolute inset-0 w-full h-full pointer-events-none opacity-20">
                            <line x1="0" y1="20%" x2="100%" y2="50%" stroke="#334155" stroke-width="1" />
                            <line x1="0" y1="50%" x2="100%" y2="50%" stroke="#334155" stroke-width="1" />
                            <line x1="0" y1="80%" x2="100%" y2="50%" stroke="#334155" stroke-width="1" />
                        </svg>
                    </div>

                    <!-- Layer 2: Hidden -->
                    <div class="flex flex-col items-center gap-1" id="layer2">
                        <div class="flex flex-col gap-4">
                            {% for i in range(3) %}
                            <div class="node w-5 h-5 rounded-full bg-purple-500/10 border border-purple-500/30"></div>
                            {% endfor %}
                        </div>
                        <span class="text-[8px] font-black text-slate-600 mt-4 uppercase">Hidden (128)</span>
                    </div>

                    <div class="flex-grow h-32 relative mx-4">
                        <svg class="absolute inset-0 w-full h-full pointer-events-none opacity-20">
                            <line x1="0" y1="50%" x2="100%" y2="30%" stroke="#334155" stroke-width="1" />
                            <line x1="0" y1="50%" x2="100%" y2="70%" stroke="#334155" stroke-width="1" />
                        </svg>
                    </div>

                    <!-- Layer 3: Output -->
                    <div class="flex flex-col items-center gap-1" id="layer4">
                        <div
                            class="node w-8 h-8 rounded-full bg-primary/20 border-2 border-primary/50 shadow-[0_0_20px_rgba(16,185,129,0.3)]">
                        </div>
                        <span class="text-[8px] font-black text-slate-600 mt-4 uppercase">Softmax (41)</span>
                    </div>
                </div>

                <div class="mt-auto pt-8">
                    <span id="activityLog"
                        class="font-mono text-[10px] text-primary/40 uppercase tracking-widest flex items-center">
                        <span class="w-1.5 h-1.5 rounded-full bg-primary/50 mr-2 animate-pulse"></span>
                        Waking up core...
                    </span>
                </div>

                <!-- Decoration Grid -->
                <div class="absolute inset-0 opacity-[0.03] pointer-events-none"
                    style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 24px 24px;">
                </div>
            </div>
        </div>

        <!-- Ayat Activation Map (0-40) -->
        <div class="lg:col-span-4 h-full">
            <div class="bg-white rounded-3xl p-8 shadow-sm border border-slate-100 h-full flex flex-col">
                <h6 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-8 text-center md:text-left">
                    Ayat Activation Map (0-40)</h6>
                <div id="verseGrid" class="grid grid-cols-5 md:grid-cols-4 xl:grid-cols-5 gap-3">
                    {% for i in range(41) %}
                    <div id="v-{{ i }}"
                        class="aspect-square rounded-xl bg-slate-50 border border-slate-100 flex items-center justify-center text-xs font-black text-slate-300 transition-all duration-300">
                        {{ i }}
                    </div>
                    {% endfor %}
                </div>

                <div class="mt-12 pt-8 border-t border-slate-100 space-y-4">
                    <div class="flex items-center gap-3">
                        <div class="w-2.5 h-2.5 rounded-full bg-emerald-500 shadow-[0_0_8px_#10b981]"></div>
                        <span
                            class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Active/Verified</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-2.5 h-2.5 rounded-full bg-blue-500 shadow-[0_0_8px_#3b82f6]"></div>
                        <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Extracted</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-2.5 h-2.5 rounded-full bg-rose-500 shadow-[0_0_8px_#f43f5e] animate-pulse"></div>
                        <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Retraining
                            Zone</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Console -->
        <div class="lg:col-span-12">
            <div class="bg-dark rounded-3xl overflow-hidden shadow-2xl border border-slate-800">
                <div class="px-6 py-4 bg-slate-900 border-b border-slate-800 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="flex gap-1.5">
                            <div class="w-3 h-3 rounded-full bg-rose-500/50"></div>
                            <div class="w-3 h-3 rounded-full bg-amber-500/50"></div>
                            <div class="w-3 h-3 rounded-full bg-emerald-500/50"></div>
                        </div>
                        <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-4">
                            <i class="bi bi-terminal mr-2"></i> Logic Console Log
                        </span>
                    </div>
                    <div id="livePulse" class="h-2 w-2 rounded-full bg-rose-500 shadow-[0_0_10px_#f43f5e] hidden"></div>
                </div>
                <div id="logConsole" class="h-72 p-8 overflow-y-auto font-mono text-sm text-slate-400 bg-[#0c121e]">
                    <div class="text-slate-600 flex items-center gap-3">
                        <span class="text-primary">></span>
                        Awaiting user initiation...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes shimmer {
        0% {
            transform: translateX(-100%) skewX(-20deg);
        }

        100% {
            transform: translateX(200%) skewX(-20deg);
        }
    }

    .node.active {
        @apply bg-primary border-primary shadow-[0_0_10px_#10b981] opacity-100 scale-125;
    }

    #logConsole::-webkit-scrollbar {
        width: 5px;
    }

    #logConsole::-webkit-scrollbar-track {
        background: transparent;
    }

    #logConsole::-webkit-scrollbar-thumb {
        background: #1e293b;
        border-radius: 10px;
    }
</style>

<script>
    const btn = document.getElementById('startTrainBtn');
    const logConsole = document.getElementById('logConsole');
    const accGraph = document.getElementById('accGraph');
    const lossGraph = document.getElementById('lossGraph');
    const verseGrid = document.getElementById('verseGrid');

    function appendLog(msg) {
        const div = document.createElement('div');
        div.className = "flex gap-4 mb-2 animate-in fade-in slide-in-from-left-2 duration-300";
        div.innerHTML = `
            <span class="text-slate-700 font-bold shrink-0">${new Date().toLocaleTimeString()}</span>
            <span class="text-primary font-bold shrink-0">></span>
            <span class="flex-grow">${msg}</span>
        `;
        logConsole.appendChild(div);
        logConsole.scrollTop = logConsole.scrollHeight;
    }

    function updateGraph(container, val, max, colorClass) {
        const height = (val / max) * 100;
        const bar = document.createElement('div');
        bar.className = `w-1.5 rounded-t-sm transition-all duration-500 ${colorClass}`;
        bar.style.height = `0%`;
        container.appendChild(bar);
        setTimeout(() => bar.style.height = `${Math.min(height, 100)}%`, 50);
        if (container.children.length > 50) container.removeChild(container.firstChild);
    }

    function pulseLayers() {
        document.querySelectorAll('.node').forEach(node => {
            node.style.transition = 'all 0.15s cubic-bezier(0.4, 0, 0.2, 1)';
            node.classList.add('bg-primary/80', 'border-primary', 'scale-125', 'shadow-[0_0_8px_#10b981]');
            setTimeout(() => {
                node.classList.remove('bg-primary/80', 'border-primary', 'scale-125', 'shadow-[0_0_8px_#10b981]');
            }, 150);
        });
    }

    btn.onclick = function () {
        appendLog('<span class="text-primary font-black uppercase tracking-widest">Initializing Deep Learning Thread...</span>');
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
        btn.innerHTML = '<i class="bi bi-hourglass-split mr-3 animate-spin"></i> Training in Progress...';

        document.getElementById('livePulse').classList.remove('hidden');

        fetch('/api/train', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                appendLog(`<span class="text-white font-black">${data.message}</span>`);
                const eventSource = new EventSource('{{ url_for("main.train_progress") }}');
                let lastLogCount = 0;

                eventSource.onmessage = function (e) {
                    const data = JSON.parse(e.data);

                    document.getElementById('statusText').innerText = data.status;
                    document.getElementById('progressPercent').innerText = data.percent + '%';
                    document.getElementById('progressBar').style.width = data.percent + '%';

                    // Sync Verse Mapping Inventory
                    if (data.mapped_verses && data.mapped_verses.length > 0) {
                        data.mapped_verses.forEach(v_id => {
                            const v = document.getElementById(`v-${v_id}`);
                            if (v && !v.classList.contains('bg-primary')) {
                                v.classList.remove('bg-slate-50', 'text-slate-300', 'border-slate-100');
                                v.classList.add('bg-primary', 'text-white', 'border-primary', 'shadow-lg', 'shadow-emerald-500/20');
                            }
                        });
                    }

                    if (data.visual_data) {
                        const viz = data.visual_data;

                        if (viz.status === 'training') {
                            const p = document.getElementById('currentPhase');
                            p.innerText = `PHASE 2: DEEP GRADIENT (EPOCH ${viz.epoch})`;
                            p.className = "inline-block px-3 py-1 rounded-full bg-purple-500/10 text-purple-500 text-[10px] font-black mb-4";

                            document.getElementById('accVal').innerText = (viz.accuracy * 100).toFixed(1) + '%';
                            document.getElementById('lossVal').innerText = viz.loss.toFixed(4);

                            updateGraph(accGraph, viz.accuracy, 1.0, 'bg-primary');
                            updateGraph(lossGraph, viz.loss, 3.0, 'bg-rose-500');
                            pulseLayers();
                            document.getElementById('activityLog').innerText = `GRADIENT DESCENT EPOCH ${viz.epoch}... UPDATING WEIGHTS...`;
                        }

                        if (viz.status === 'correcting') {
                            const p = document.getElementById('currentPhase');
                            p.innerText = `PHASE 3: FORCED RETRAINING (AYAT ${viz.current_verse})`;
                            p.className = "inline-block px-3 py-1 rounded-full bg-rose-500/10 text-rose-500 text-[10px] font-black mb-4";

                            const v = document.getElementById(`v-${viz.current_verse}`);
                            if (v) {
                                v.classList.add('animate-pulse', 'bg-rose-500', 'border-rose-600', 'shadow-[0_0_15px_#f43f5e]');
                            }
                        }
                    }

                    // Process ALL new logs
                    if (data.logs && data.logs.length > lastLogCount) {
                        for (let i = lastLogCount; i < data.logs.length; i++) {
                            const fullLog = data.logs[i];
                            const logMsg = fullLog.split('] ')[1] || fullLog;
                            appendLog(logMsg);
                        }
                        lastLogCount = data.logs.length;
                    }

                    if (!data.is_training && data.percent === 100) {
                        eventSource.close();
                        btn.innerHTML = '<i class="bi bi-check-circle-fill mr-3"></i> Training Selesai';
                        btn.classList = 'flex items-center px-6 py-3 bg-emerald-600 text-white font-black rounded-2xl shadow-lg';
                        document.getElementById('livePulse').classList.add('hidden');

                        if (data.summary) {
                            appendLog(`
                                <div class="mt-6 p-6 bg-emerald-500/10 rounded-3xl border border-emerald-500/30 backdrop-blur-sm">
                                    <p class="text-emerald-400 font-black mb-4 flex items-center gap-2 uppercase tracking-widest text-xs">
                                        <i class="bi bi-trophy text-lg"></i> Hasil Akhir Evaluasi
                                    </p>
                                    <div class="grid grid-cols-3 gap-6">
                                        <div class="bg-black/40 p-4 rounded-2xl text-center border border-white/5">
                                            <p class="text-[8px] font-black text-slate-500 uppercase tracking-widest mb-1">Accuracy</p>
                                            <p class="text-lg font-black text-emerald-500">${data.summary.accuracy}</p>
                                        </div>
                                        <div class="bg-black/40 p-4 rounded-2xl text-center border border-white/5">
                                            <p class="text-[8px] font-black text-slate-500 uppercase tracking-widest mb-1">Loss</p>
                                            <p class="text-lg font-black text-amber-500">${data.summary.loss}</p>
                                        </div>
                                        <div class="bg-black/40 p-4 rounded-2xl text-center border border-white/5">
                                            <p class="text-[8px] font-black text-slate-500 uppercase tracking-widest mb-1">F1 Score</p>
                                            <p class="text-lg font-black text-indigo-400">${data.summary.f1}</p>
                                        </div>
                                    </div>
                                    <p class="text-[9px] text-slate-600 mt-4 text-center font-bold italic tracking-tighter">Verified Cortex Model - Exported to metrics.json</p>
                                </div>
                            `);
                        }

                        Array.from(verseGrid.children).forEach(v => {
                            v.classList.remove('animate-pulse', 'bg-rose-500', 'border-rose-600');
                            v.classList.add('bg-emerald-500', 'text-white', 'border-emerald-600', 'shadow-emerald-500/20');
                        });
                    }
                };
            });
    }
</script>
{% endblock %}